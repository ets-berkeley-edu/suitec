/**
 * Copyright 2015 UC Berkeley (UCB) Licensed under the
 * Educational Community License, Version 2.0 (the "License"); you may
 * not use this file except in compliance with the License. You may
 * obtain a copy of the License at
 *
 *     http://opensource.org/licenses/ECL-2.0
 *
 * Unless required by applicable law or agreed to in writing,
 * software distributed under the License is distributed on an "AS IS"
 * BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express
 * or implied. See the License for the specific language governing
 * permissions and limitations under the License.
 */

var moment = require('moment-timezone');
var util = require('util');

var Collabosphere = require('col-core');
var CollabosphereUtil = require('col-core/lib/util');

var ActivitiesAPI = require('./api');

/*!
 * Export the activities for a course as a CSV file
 */
Collabosphere.apiRouter.get('/activities.csv', function(req, res) {
  ActivitiesAPI.exportActivities(req.ctx, function(err, activities) {
    if (err) {
      return res.status(err.code).send(err.msg);
    }

    // TODO: This date should be dependent on where the course is being given. Canvas doesn't give
    // us this information however so we default it to the Pacific timezone
    var date = moment().tz('America/Los_Angeles').format('YYYY_MM_DD_HH_mm');
    var filename = util.format('engagement_index_activities_%d_%s.csv', req.ctx.course.canvas_course_id, date);
    var dispositionHeader = util.format('attachment; filename="%s"', filename);
    res.set('Content-Disposition', dispositionHeader);
    res.set('Content-Type', 'text/csv');
    return res.status(200).send(activities);
  });
});

/*!
 * Get the activity type configuration for a course
 */
Collabosphere.apiRouter.get('/activities/configuration', function(req, res) {
  ActivitiesAPI.getActivityTypeConfiguration(req.ctx.course.id, function(err, configuration) {
    if (err) {
      return res.status(err.code).send(err.msg);
    }

    return res.status(200).send(configuration);
  });
});

/*!
 * Edit the activity type configuration for a course
 */
Collabosphere.apiRouter.post('/activities/configuration', function(req, res) {
  ActivitiesAPI.editActivityTypeConfiguration(req.ctx, req.body, function(err) {
    if (err) {
      return res.status(err.code).send(err.msg);
    }

    return res.sendStatus(200);
  });
});
