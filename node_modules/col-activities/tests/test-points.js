/**
 * Copyright 2015 UC Berkeley (UCB) Licensed under the
 * Educational Community License, Version 2.0 (the "License"); you may
 * not use this file except in compliance with the License. You may
 * obtain a copy of the License at
 *
 *     http://opensource.org/licenses/ECL-2.0
 *
 * Unless required by applicable law or agreed to in writing,
 * software distributed under the License is distributed on an "AS IS"
 * BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express
 * or implied. See the License for the specific language governing
 * permissions and limitations under the License.
 */

var _ = require('lodash');
var assert = require('assert');

var AssetsTestUtil = require('col-assets/tests/util');
var TestsUtil = require('col-tests');
var UsersTestsUtil = require('col-users/tests/util');
var WhiteboardsTestUtil = require('col-whiteboards/tests/util');

var ActivitiesTestUtil = require('./util');

describe('Activity Points', function() {

  /**
   * Test that verifies that users do not earn points for disabled activities
   */
  it('does not update the points for disabled activities', function(callback) {
    TestsUtil.getAssetLibraryClient(null, null, null, function(client1, course, user1) {
      TestsUtil.getAssetLibraryClient(null, course, null, function(client2, course, user2) {
        TestsUtil.getAssetLibraryClient(null, course, null, function(client3, course, user3) {
          var instructorUser = TestsUtil.generateInstructor();
          TestsUtil.getAssetLibraryClient(null, course, instructorUser, function(instructorClient, course, instructorUser) {

            var activityTypeOverride = [{
              'type': 'add_asset',
              'enabled': false
            }];
            ActivitiesTestUtil.assertEditActivityTypeConfiguration(instructorClient, course, activityTypeOverride, function() {

              // As no activities have occurred yet, each user should have 0 points
              UsersTestsUtil.assertGetLeaderboard(instructorClient, course, 4, true, function(users) {
                _.each(users, function(user) {
                  assert.strictEqual(user.points, 0);
                });

                // Each user adds an asset
                AssetsTestUtil.assertCreateLink(client1, course, 'UC Davis', 'http://www.ucdavis.edu/', null, function(asset1) {
                  AssetsTestUtil.assertCreateLink(client2, course, 'UC Davis', 'http://www.ucdavis.edu/', null, function(asset2) {
                    AssetsTestUtil.assertCreateLink(client3, course, 'UC Davis', 'http://www.ucdavis.edu/', null, function(asset3) {

                      // Because we disabled the `add_asset`, each user should still have 0 points
                      UsersTestsUtil.assertGetLeaderboard(instructorClient, course, 4, true, function(users) {
                        _.each(users, function(user) {
                          assert.strictEqual(user.points, 0);
                        });

                        // Each user likes another asset
                        AssetsTestUtil.assertLike(client1, course, asset2.id, true, function() {
                          AssetsTestUtil.assertLike(client2, course, asset3.id, true, function() {
                            AssetsTestUtil.assertLike(client3, course, asset1.id, true, function() {

                              // As the `like` and `get_like` activities are still enabled, users should still earn points
                              ActivitiesTestUtil.assertGetActivityTypeConfiguration(instructorClient, course, function(configuration) {
                                var likePoints = _.find(configuration, {'type': 'like'}).points;
                                var getLikePoints = _.find(configuration, {'type': 'get_like'}).points;
                                UsersTestsUtil.assertGetLeaderboard(instructorClient, course, 4, true, function(users) {
                                  _.each(users, function(user) {
                                    if (!user.is_admin) {
                                      assert.strictEqual(user.points, likePoints + getLikePoints);
                                    }
                                  });

                                  return callback();
                                });
                              });
                            });
                          });
                        });
                      });
                    });
                  });
                });
              });
            });
          });
        });
      });
    });
  });

  describe('Create a new asset', function() {

    /**
     * Test that verifies that creating a new link asset updates the points for the creator
     */
    it('updates the points', function(callback) {
      TestsUtil.getAssetLibraryClient(null, null, null, function(client, course, user) {
        // Verify that creating a new link asset correctly updates the points
        ActivitiesTestUtil.assertCreateLinkActivity(client, course, 'UC Davis', 'http://www.ucdavis.edu/', null, function(asset1) {
          // Verify that creating another link asset correctly updates the points
          ActivitiesTestUtil.assertCreateLinkActivity(client, course, 'UC Berkeley', 'http://www.berkeley.edu/', null, function(asset2) {
            return callback();
          });
        });
      });
    });
  });

  describe('Liking', function() {

    /**
     * Test that verifies that liking an asset updates the points for the liker and the
     * user receiving the like
     */
    it('updates the points when liking', function(callback) {
      TestsUtil.getAssetLibraryClient(null, null, null, function(client1, course, user1) {
        AssetsTestUtil.assertCreateLink(client1, course, 'UC Davis', 'http://www.ucdavis.edu/', null, function(asset) {

          // Verify that liking an asset correctly updates the points
          TestsUtil.getAssetLibraryClient(null, course, null, function(client2, course, user2) {
            ActivitiesTestUtil.assertLikeActivity(client2, client1, course, asset.id, true, function() {

              // Verify that re-liking an asset doesn't update the points
              ActivitiesTestUtil.assertLikeActivity(client2, client1, course, asset.id, true, function() {

                return callback();
              });
            });
          });
        });
      });
    });

    /**
     * Test that verifies that exporting a whiteboard as an asset updates the points for everyone
     * who collaborated on it
     */
    it('updates the points when exporting a whiteboard as an asset', function(callback) {
      TestsUtil.getAssetLibraryClient(null, null, null, function(client1, course, user1) {
        TestsUtil.getAssetLibraryClient(null, course, null, function(client2, course, user2) {
          UsersTestsUtil.assertGetMe(client2, course, null, function(user2Me) {

            // Create a whiteboard with a few elements in it and share it with the second user
            WhiteboardsTestUtil.assertCreateWhiteboardWithElements(client1, course, 'UC Berkeley Whiteboard', user2Me.id, function(whiteboard) {

              // Export the whiteboard to an asset
              ActivitiesTestUtil.assertExportWhiteboardToAssetActivity(client1, course, whiteboard.id, null, null, function(data) {

                return callback();
              });
            });
          });
        });
      });
    });

    /**
     * Test that verifies that disliking an asset updates the points for the disliker and the
     * user receiving the dislike
     */
    it('updates the points when disliking', function(callback) {
      TestsUtil.getAssetLibraryClient(null, null, null, function(client1, course, user1) {
        AssetsTestUtil.assertCreateLink(client1, course, 'UC Davis', 'http://www.ucdavis.edu/', null, function(asset) {

          // Verify that disliking an asset correctly updates the points
          TestsUtil.getAssetLibraryClient(null, course, null, function(client2, course, user2) {
            ActivitiesTestUtil.assertLikeActivity(client2, client1, course, asset.id, false, function() {

              // Verify that re-disliking an asset doesn't update the points
              ActivitiesTestUtil.assertLikeActivity(client2, client1, course, asset.id, false, function() {

                return callback();
              });
            });
          });
        });
      });
    });

    /**
     * Test that verifies that updating a like or dislike updates the points for the (dis)liker and the
     * user receiving the (dis)like
     */
    it('updates the points when liking or disliking', function(callback) {
      TestsUtil.getAssetLibraryClient(null, null, null, function(client1, course, user1) {
        AssetsTestUtil.assertCreateLink(client1, course, 'UC Davis', 'http://www.ucdavis.edu/', null, function(asset) {

          // Verify that undoing a like updates the points
          TestsUtil.getAssetLibraryClient(null, course, null, function(client2, course, user2) {
            ActivitiesTestUtil.assertLikeActivity(client2, client1, course, asset.id, true, function() {
              ActivitiesTestUtil.assertLikeActivity(client2, client1, course, asset.id, null, function() {

                // Verify that undoing a dislike updates the points
                ActivitiesTestUtil.assertLikeActivity(client2, client1, course, asset.id, false, function() {
                  ActivitiesTestUtil.assertLikeActivity(client2, client1, course, asset.id, null, function() {

                    // Verify that switching a dislike to a like updates the points
                    ActivitiesTestUtil.assertLikeActivity(client2, client1, course, asset.id, false, function() {
                      ActivitiesTestUtil.assertLikeActivity(client2, client1, course, asset.id, true, function() {

                        // Verify that switching a like to a dislike updates the points
                        ActivitiesTestUtil.assertLikeActivity(client2, client1, course, asset.id, false, function() {

                          return callback();
                        });
                      });
                    });
                  });
                });
              });
            });
          });
        });
      });
    });
  });
});
