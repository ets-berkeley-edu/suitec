/**
 * Copyright Â©2016. The Regents of the University of California (Regents). All Rights Reserved.
 *
 * Permission to use, copy, modify, and distribute this software and its documentation
 * for educational, research, and not-for-profit purposes, without fee and without a
 * signed licensing agreement, is hereby granted, provided that the above copyright
 * notice, this paragraph and the following two paragraphs appear in all copies,
 * modifications, and distributions.
 *
 * Contact The Office of Technology Licensing, UC Berkeley, 2150 Shattuck Avenue,
 * Suite 510, Berkeley, CA 94720-1620, (510) 643-7201, otl@berkeley.edu,
 * http://ipira.berkeley.edu/industry-info for commercial licensing opportunities.
 *
 * IN NO EVENT SHALL REGENTS BE LIABLE TO ANY PARTY FOR DIRECT, INDIRECT, SPECIAL,
 * INCIDENTAL, OR CONSEQUENTIAL DAMAGES, INCLUDING LOST PROFITS, ARISING OUT OF
 * THE USE OF THIS SOFTWARE AND ITS DOCUMENTATION, EVEN IF REGENTS HAS BEEN ADVISED
 * OF THE POSSIBILITY OF SUCH DAMAGE.
 *
 * REGENTS SPECIFICALLY DISCLAIMS ANY WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE
 * IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE. THE
 * SOFTWARE AND ACCOMPANYING DOCUMENTATION, IF ANY, PROVIDED HEREUNDER IS PROVIDED
 * "AS IS". REGENTS HAS NO OBLIGATION TO PROVIDE MAINTENANCE, SUPPORT, UPDATES,
 * ENHANCEMENTS, OR MODIFICATIONS.
 */

var _ = require('lodash');
var assert = require('assert');
var fs = require('fs');
var randomstring = require('randomstring');

var CategoriesTestUtil = require('col-categories/tests/util');
var CollabosphereConstants = require('col-core/lib/constants');
var TestsUtil = require('col-tests');
var UsersAPI = require('col-users');
var UsersTestUtil = require('col-users/tests/util');
var WhiteboardsTestUtil = require('col-whiteboards/tests/util');

var AssetsTestUtil = require('./util');

describe('Assets', function() {

  /**
   * Get a file stream
   *
   * @param  {String}   filename    The name of the file in the `data` directory
   * @return {Stream}               A readable stream to the file on disk
   */
  var getFileStream = function(filename) {
    return fs.createReadStream(__dirname + '/data/' + filename);
  };

  describe('Create new assets', function() {

    describe('Links', function() {

      /**
       * Test that verifies that a new link asset can be created
       */
      it('can be created', function(callback) {
        TestsUtil.getAssetLibraryClient(null, null, null, function(client, course, user) {
          // Create a link asset with no optional metadata
          AssetsTestUtil.assertCreateLink(client, course, 'UC Davis', 'http://www.ucdavis.edu/', null, function(asset) {

            // Create a link asset with no title. This should default the title to the provided URL
            var url = 'http://uci.edu';
            AssetsTestUtil.assertCreateLink(client, course, null, url, null, function(asset) {
              assert.equal(asset.title, url);

              // Create a link asset with optional metadata
              var opts = {
                'description': 'University of California, Berkeley homepage',
                'source': 'http://www.universityofcalifornia.edu/uc-system',
                'thumbnail_url': 'https://previews.s3.amazonaws.com/uploads/110198/352390/thumbnail.jpeg?AWSAccessKeyId=AKIAJ4WBDILJQGNGADIQ&Expires=1761522146&Signature=bU7ABJ8yyb9iX1zK3yvkTd1cl1s%3D',
                'image_url': 'https://previews.s3.amazonaws.com/uploads/110198/352390/image.jpeg?AWSAccessKeyId=AKIAJ4WBDILJQGNGADIQ&Expires=1761522146&Signature=bU7ABJ8yyb9iX1zK3yvkTd1cl1s%3D',
                'pdf_url': 'https://previews.s3.amazonaws.com/uploads/110198/352390/image.jpeg?AWSAccessKeyId=AKIAJ4WBDILJQGNGADIQ&Expires=1761522146&Signature=bU7ABJ8yyb9iX1zK3yvkTd1cl1s%3D',
                'metadata': '{"foo": "bar"}'
              };
              AssetsTestUtil.assertCreateLink(client, course, 'UC Berkeley', 'http://www.berkeley.edu/', opts, function(asset) {

                // Verify that `thumbnail_url`, `image_url`, `pdf_url` and `metadata`
                // were not set as these can only be set through the preview service
                assert.ok(!asset.thumbnail_url);
                assert.ok(!asset.image_url);
                assert.ok(!asset.pdf_url);
                assert.ok(!asset.metadata);

                return callback();
              });
            });
          });
        });
      });

      /**
       * Test that verifies validation when creating a new link asset
       */
      it('is validated', function(callback) {
        TestsUtil.getAssetLibraryClient(null, null, null, function(client, course, user) {
          // Too long title
          AssetsTestUtil.assertCreateLinkFails(client, course, randomstring.generate(256), 'http://www.berkeley.edu/', null, 400, function() {

            // Missing URL
            AssetsTestUtil.assertCreateLinkFails(client, course, 'UC Berkeley', null, null, 400, function() {
              // Invalid URL
              AssetsTestUtil.assertCreateLinkFails(client, course, 'UC Berkeley', 'invalid url', null, 400, function() {
                AssetsTestUtil.assertCreateLinkFails(client, course, 'UC Berkeley', '/invalidurl', null, 400, function() {
                  // Too long URL
                  AssetsTestUtil.assertCreateLinkFails(client, course, 'UC Berkeley', 'http://www.berkeley.edu/?q=' + randomstring.generate(229), null, 400, function() {

                    return callback();
                  });
                });
              });
            });
          });
        });
      });
    });

    describe('File', function() {

      /**
       * Test that verifies that a new file asset can be created
       */
      it('can be created', function(callback) {
        TestsUtil.getAssetLibraryClient(null, null, null, function(client, course, user) {
          // Create a file asset with no optional metadata
          AssetsTestUtil.assertCreateFile(client, course, 'UC Davis', getFileStream('logo-ucberkeley.png'), null, function(asset) {

            // Create a file asset with no title. This should default the title to the name of the file
            AssetsTestUtil.assertCreateFile(client, course, null, getFileStream('logo-ucberkeley.png'), null, function(asset) {
              assert.equal(asset.title, 'logo-ucberkeley.png');

              // Create a file asset with optional metadata
              var opts = {
                'description': 'University of California, Berkeley logo',
                'source': 'http://www.universityofcalifornia.edu/uc-system'
              };
              AssetsTestUtil.assertCreateFile(client, course, 'UC Berkeley', getFileStream('logo-ucberkeley.png'), opts, function(asset) {

                return callback();
              });
            });
          });
        });
      });

      /**
       * Test that verifies validation when creating a new file asset
       */
      it('is validated', function(callback) {
        TestsUtil.getAssetLibraryClient(null, null, null, function(client, course, user) {
          // Missing file
          AssetsTestUtil.assertCreateFileFails(client, course, 'UC Berkeley', null, null, 400, function() {
            // Invalid file
            AssetsTestUtil.assertCreateFileFails(client, course, 'UC Berkeley', 'invalid file', null, 400, function() {
              AssetsTestUtil.assertCreateFileFails(client, course, 'UC Berkeley', '42', null, 400, function() {

                // Invalid source
                AssetsTestUtil.assertCreateFileFails(client, course, 'UC Berkeley', getFileStream('logo-ucberkeley.png'), {'source': 'invalid url'}, 400, function() {
                  AssetsTestUtil.assertCreateFileFails(client, course, 'UC Berkeley', getFileStream('logo-ucberkeley.png'), {'source': '/invalidurl'}, 400, function() {

                    return callback();
                  });
                });
              });
            });
          });
        });
      });
    });

    describe('Bookmarklet', function() {

      /**
       * Test that verifies that a new link asset can be created through the Bookmarklet
       */
      it('can be created', function(callback) {
        TestsUtil.getAssetLibraryClient(null, null, null, function(client, course, user) {
          UsersTestUtil.assertGetMe(client, course, null, function(me) {
            var bookmarkletClient = TestsUtil.getAnonymousClient();

            // Create a link asset with no optional metadata
            AssetsTestUtil.assertCreateLinkBookmarklet(bookmarkletClient, course, me.id, me.bookmarklet_token, 'UC Davis', 'http://www.ucdavis.edu/', null, function(asset) {

              // Create a link asset with no title. This should default the title to the provided URL
              var url = 'http://uci.edu';
              AssetsTestUtil.assertCreateLinkBookmarklet(bookmarkletClient, course, me.id, me.bookmarklet_token, null, url, null, function(asset) {
                assert.equal(asset.title, url);

                // Create a link asset with optional metadata
                var opts = {
                  'description': 'University of California, Berkeley homepage',
                  'source': 'http://www.universityofcalifornia.edu/uc-system'
                };
                AssetsTestUtil.assertCreateLinkBookmarklet(bookmarkletClient, course, me.id, me.bookmarklet_token, 'UC Berkeley', 'http://www.berkeley.edu/', opts, function(asset) {

                  return callback();
                });
              });
            });
          });
        });
      });

      /**
       * Test that verifies validation when creating a new link asset through the Bookmarklet
       */
      it('is validated', function(callback) {
        TestsUtil.getAssetLibraryClient(null, null, null, function(client, course, user) {
          UsersTestUtil.assertGetMe(client, course, null, function(me) {
            var bookmarkletClient = TestsUtil.getAnonymousClient();

            // Too long title
            AssetsTestUtil.assertCreateLinkBookmarkletFails(bookmarkletClient, course, me.id, me.bookmarklet_token, randomstring.generate(256), 'http://www.berkeley.edu/', null, 400, function() {

              // Missing URL
              AssetsTestUtil.assertCreateLinkBookmarkletFails(bookmarkletClient, course, me.id, me.bookmarklet_token, 'UC Berkeley', null, null, 400, function() {
                // Invalid URL
                AssetsTestUtil.assertCreateLinkBookmarkletFails(bookmarkletClient, course, me.id, me.bookmarklet_token, 'UC Berkeley', 'invalid url', null, 400, function() {
                  AssetsTestUtil.assertCreateLinkBookmarkletFails(bookmarkletClient, course, me.id, me.bookmarklet_token, 'UC Berkeley', '/invalidurl', null, 400, function() {
                    // Too long URL
                    AssetsTestUtil.assertCreateLinkBookmarkletFails(bookmarkletClient, course, me.id, me.bookmarklet_token, 'UC Berkeley', 'http://www.berkeley.edu/?q=' + randomstring.generate(229), null, 400, function() {

                      // Invalid source
                      AssetsTestUtil.assertCreateLinkBookmarkletFails(bookmarkletClient, course, me.id, me.bookmarklet_token, 'UC Berkeley', 'http://www.berkeley.edu/', {'source': 'invalid url'}, 400, function() {
                        AssetsTestUtil.assertCreateLinkBookmarkletFails(bookmarkletClient, course, me.id, me.bookmarklet_token, 'UC Berkeley', 'http://www.berkeley.edu/', {'source': '/invalidurl'}, 400, function() {

                          return callback();
                        });
                      });
                    });
                  });
                });
              });
            });
          });
        });
      });

      /**
       * Test that verifies authorization when creating a new link asset through the Bookmarklet
       */
      it('verifies bookmarklet token authorization', function(callback) {
        TestsUtil.getAssetLibraryClient(null, null, null, function(client, course, user) {
          UsersTestUtil.assertGetMe(client, course, null, function(me) {
            var bookmarkletClient = TestsUtil.getAnonymousClient();

            // Missing token and user id
            AssetsTestUtil.assertCreateLinkBookmarkletFails(bookmarkletClient, course, null, null, 'UC Berkeley', 'http://www.berkeley.edu/', null, 401, function() {
              // Missing token
              AssetsTestUtil.assertCreateLinkBookmarkletFails(bookmarkletClient, course, me.id, null, 'UC Berkeley', 'http://www.berkeley.edu/', null, 401, function() {
                // Missing user id
                AssetsTestUtil.assertCreateLinkBookmarkletFails(bookmarkletClient, course, null, me.bookmarklet_token, 'UC Berkeley', 'http://www.berkeley.edu/', null, 401, function() {

                  // Incorrect token
                  TestsUtil.getAssetLibraryClient(null, course, null, function(otherClient, course, otherUser) {
                    UsersTestUtil.assertGetMe(otherClient, course, null, function(otherMe) {
                      AssetsTestUtil.assertCreateLinkBookmarkletFails(bookmarkletClient, course, me.id, otherMe.bookmarklet_token, 'UC Berkeley', 'http://www.berkeley.edu/', null, 401, function() {
                        // Incorrect user id
                        AssetsTestUtil.assertCreateLinkBookmarkletFails(bookmarkletClient, course, otherMe.id, me.bookmarklet_token, 'UC Berkeley', 'http://www.berkeley.edu/', null, 401, function() {

                          // Ensure that the second user can create a new link asset through the Bookmarklet as well
                          AssetsTestUtil.assertCreateLinkBookmarklet(bookmarkletClient, course, otherMe.id, otherMe.bookmarklet_token, 'UC Davis', 'http://www.ucdavis.edu/', null, function(asset) {

                            return callback();
                          });
                        });
                      });
                    });
                  });
                });
              });
            });
          });
        });
      });

      /**
       * Test that verifies that only active users can add assets through the Bookmarklet
       */
      it('verifies only active users can add assets through bookmarklet', function(callback) {
        TestsUtil.getAssetLibraryClient(null, null, null, function(client, course, user) {
          UsersTestUtil.assertGetMe(client, course, null, function(me) {
            var bookmarkletClient = TestsUtil.getAnonymousClient();

            // Verify the user is able to create an asset through the bookmarklet while still enrolled
            AssetsTestUtil.assertCreateLinkBookmarklet(bookmarkletClient, course, me.id, me.bookmarklet_token, 'UC Davis', 'http://www.ucdavis.edu/', null, function(asset) {

              // Change the enrollment state of the user and verify that adding an asset
              // through the bookmarklet is no longer possible
              UsersAPI.updateUsers([me.id], {'canvas_enrollment_state': CollabosphereConstants.ENROLLMENT_STATE.COMPLETED}, function(err) {
                assert.ok(!err);
                AssetsTestUtil.assertCreateLinkBookmarkletFails(bookmarkletClient, course, me.id, me.bookmarklet_token, 'UC Berkeley', 'http://www.ucberkeley.edu/', null, 401, function() {

                  UsersAPI.updateUsers([me.id], {'canvas_enrollment_state': CollabosphereConstants.ENROLLMENT_STATE.INACTIVE}, function(err) {
                    assert.ok(!err);
                    AssetsTestUtil.assertCreateLinkBookmarkletFails(bookmarkletClient, course, me.id, me.bookmarklet_token, 'UC Berkeley', 'http://www.ucberkeley.edu/', null, 401, function() {

                      UsersAPI.updateUsers([me.id], {'canvas_enrollment_state': CollabosphereConstants.ENROLLMENT_STATE.INVITED}, function(err) {
                        assert.ok(!err);
                        AssetsTestUtil.assertCreateLinkBookmarkletFails(bookmarkletClient, course, me.id, me.bookmarklet_token, 'UC Berkeley', 'http://www.ucberkeley.edu/', null, 401, function() {

                          UsersAPI.updateUsers([me.id], {'canvas_enrollment_state': CollabosphereConstants.ENROLLMENT_STATE.REJECTED}, function(err) {
                            assert.ok(!err);
                            AssetsTestUtil.assertCreateLinkBookmarkletFails(bookmarkletClient, course, me.id, me.bookmarklet_token, 'UC Berkeley', 'http://www.ucberkeley.edu/', null, 401, function() {

                              // Verify that only the first asset has been created
                              AssetsTestUtil.assertGetAssets(client, course, null, null, null, 1, function(assets) {
                                assert.ok(assets.results[0].id);
                                assert.strictEqual(assets.results[0].id, asset.id);

                                return callback();
                              });
                            });
                          });
                        });
                      });
                    });
                  });
                });
              });
            });
          });
        });
      });
    });
  });

  describe('Get asset', function() {

    /**
     * Test that verifies that an asset can be retrieved
     */
    it('can be retrieved', function(callback) {
      TestsUtil.getAssetLibraryClient(null, null, null, function(client, course, user) {
        // Create a link asset with no optional metadata
        AssetsTestUtil.assertCreateLink(client, course, 'UC Davis', 'http://www.ucdavis.edu/', null, function(asset) {
          AssetsTestUtil.assertGetAsset(client, course, asset.id, asset, 0, function(asset) {

            // Create a link asset with optional metadata
            var opts = {
              'description': 'University of California, Berkeley homepage',
              'source': 'http://www.universityofcalifornia.edu/uc-system'
            };
            AssetsTestUtil.assertCreateLink(client, course, 'UC Berkeley', 'http://www.berkeley.edu/', opts, function(asset) {
              AssetsTestUtil.assertGetAsset(client, course, asset.id, asset, 0, function(asset) {

                // Create a file asset with no optional metadata
                AssetsTestUtil.assertCreateFile(client, course, 'UC Berkeley', getFileStream('logo-ucberkeley.png'), null, function(asset) {
                  AssetsTestUtil.assertGetAsset(client, course, asset.id, asset, 0, function(asset) {

                    // Create a file asset with optional metadata
                    opts = {
                      'description': 'University of California, Berkeley logo',
                      'source': 'http://www.universityofcalifornia.edu/uc-system'
                    };
                    AssetsTestUtil.assertCreateFile(client, course, 'UC Berkeley', getFileStream('logo-ucberkeley.png'), opts, function(asset) {
                      AssetsTestUtil.assertGetAsset(client, course, asset.id, asset, 0, function(asset) {

                        return callback();
                      });
                    });
                  });
                });
              });
            });
          });
        });
      });
    });

    /**
     * Test that verifies validation when retrieving an asset
     */
    it('is validated', function(callback) {
      TestsUtil.getAssetLibraryClient(null, null, null, function(client, course, user) {
        AssetsTestUtil.assertCreateLink(client, course, 'UC Davis', 'http://www.ucdavis.edu/', null, function(asset) {

          // Invalid asset id
          AssetsTestUtil.assertGetAssetFails(client, course, 'Not a number', 400, function() {
            AssetsTestUtil.assertGetAssetFails(client, course, -1, 404, function() {
              AssetsTestUtil.assertGetAssetFails(client, course, 234234233, 404, function() {

                return callback();
              });
            });
          });
        });
      });
    });

    /**
     * Test that verifies authorization when retrieving an asset
     */
    it('verifies asset retrieval authorization', function(callback) {
      TestsUtil.getAssetLibraryClient(null, null, null, function(client, course, user) {
        AssetsTestUtil.assertCreateLink(client, course, 'UC Davis', 'http://www.ucdavis.edu/', null, function(asset) {

          // Verify that a user from a different course is not able to retrieve the created asset
          TestsUtil.getAssetLibraryClient(null, null, null, function(otherClient, otherCourse, otherUser) {
            AssetsTestUtil.assertGetAssetFails(otherClient, otherCourse, asset.id, 404, function(asset) {

              return callback();
            });
          });
        });
      });
    });

    /**
     * Test that verifies that the total number of asset views is updated correctly
     */
    it('increments total number of views', function(callback) {
      TestsUtil.getAssetLibraryClient(null, null, null, function(client1, course, user1) {
        TestsUtil.getAssetLibraryClient(null, course, null, function(client2, course, user2) {
          AssetsTestUtil.assertCreateLink(client1, course, 'UC Davis', 'http://www.ucdavis.edu/', null, function(asset) {
            assert.strictEqual(asset.views, 0);

            // Verify the total number of views is incremented
            AssetsTestUtil.assertGetAsset(client1, course, asset.id, asset, 0, function(asset) {
              assert.strictEqual(asset.views, 1);

              // Verify the total number of views is incremented again when requested by a different user
              AssetsTestUtil.assertGetAsset(client2, course, asset.id, asset, 0, function(asset) {
                assert.strictEqual(asset.views, 2);

                return callback();
              });
            });
          });
        });
      });
    });
  });

  describe('Get assets', function() {

    /**
     * Test that verifies that the assets in a course can be retrieved
     */
    it('can be retrieved', function(callback) {
      TestsUtil.getAssetLibraryClient(null, null, null, function(client1, course, user1) {
        // Retrieve the empty course asset list
        AssetsTestUtil.assertGetAssets(client1, course, null, null, null, 0, function(assets) {

          // Add a link and verify that is returned as part of the course asset list
          AssetsTestUtil.assertCreateLink(client1, course, 'UC Davis', 'http://www.ucdavis.edu/', null, function(asset1) {
            AssetsTestUtil.assertGetAssets(client1, course, null, null, null, 1, function(assets) {
              AssetsTestUtil.assertAsset(assets.results[0], {'expectedAsset': asset1});

              // Add another link as a second user and verify that is also returned as part of the course asset list
              TestsUtil.getAssetLibraryClient(null, course, null, function(client2, course, user2) {
                AssetsTestUtil.assertCreateLink(client2, course, 'UC Berkeley', 'http://www.berkeley.edu/', null, function(asset2) {
                  AssetsTestUtil.assertGetAssets(client2, course, null, null, null, 2, function(assets) {
                    // The results are expected to return in descending creation date order
                    AssetsTestUtil.assertAsset(assets.results[0], {'expectedAsset': asset2});
                    AssetsTestUtil.assertAsset(assets.results[1], {'expectedAsset': asset1});

                    // Add a file and verify that it is returned as part of the course asset list
                    var opts = {
                      'description': 'University of California, Berkeley logo',
                      'source': 'http://www.universityofcalifornia.edu/uc-system'
                    };
                    AssetsTestUtil.assertCreateFile(client2, course, 'UC Berkeley', getFileStream('logo-ucberkeley.png'), opts, function(asset3) {
                      AssetsTestUtil.assertGetAssets(client2, course, null, null, null, 3, function(assets) {
                        // The results are expected to return in descending creation date order
                        AssetsTestUtil.assertAsset(assets.results[0], {'expectedAsset': asset3});
                        AssetsTestUtil.assertAsset(assets.results[1], {'expectedAsset': asset2});
                        AssetsTestUtil.assertAsset(assets.results[2], {'expectedAsset': asset1});

                        return callback();
                      });
                    });
                  });
                });
              });
            });
          });
        });
      });
    });

    /**
     * Test that verifies that the assets in a course can be paged
     */
    it('can be paged', function(callback) {
      // Generate a number of test assets for a course
      TestsUtil.getAssetLibraryClient(null, null, null, function(client, course, user) {
        TestsUtil.generateTestAssets(client, course, 12, function(assets) {

          // The results are expected to return in descending creation date order
          assets = _.sortBy(assets, 'id').reverse();

          // Verify that the page size defaults to 10 and the page defaults to the first page
          AssetsTestUtil.assertGetAssets(client, course, null, null, null, 12, function(pagedAssets) {
            assert.strictEqual(pagedAssets.results.length, 10);
            _.each(pagedAssets.results, function(pagedAsset, index) {
              AssetsTestUtil.assertAsset(pagedAsset, {'expectedAsset': assets[index]});
            });

            // Verify that the second page can be retrieved
            AssetsTestUtil.assertGetAssets(client, course, null, null, 10, 12, function(pagedAssets) {
              assert.strictEqual(pagedAssets.results.length, 2);
              _.each(pagedAssets.results, function(pagedAsset, index) {
                AssetsTestUtil.assertAsset(pagedAsset, {'expectedAsset': assets[10 + index]});
              });

              // Verify that a custom page size can be specified
              AssetsTestUtil.assertGetAssets(client, course, null, 5, null, 12, function(pagedAssets) {
                assert.strictEqual(pagedAssets.results.length, 5);
                _.each(pagedAssets.results, function(pagedAsset, index) {
                  AssetsTestUtil.assertAsset(pagedAsset, {'expectedAsset': assets[index]});
                });
                // Get the second page using the custom page size
                AssetsTestUtil.assertGetAssets(client, course, null, 5, 5, 12, function(pagedAssets) {
                  assert.strictEqual(pagedAssets.results.length, 5);
                  _.each(pagedAssets.results, function(pagedAsset, index) {
                    AssetsTestUtil.assertAsset(pagedAsset, {'expectedAsset': assets[5 + index]});
                  });
                  // Get the last page using the custom page size
                  AssetsTestUtil.assertGetAssets(client, course, null, 5, 10, 12, function(pagedAssets) {
                    assert.strictEqual(pagedAssets.results.length, 2);
                    _.each(pagedAssets.results, function(pagedAsset, index) {
                      AssetsTestUtil.assertAsset(pagedAsset, {'expectedAsset': assets[10 + index]});
                    });
                    // Verify that further pages will be empty
                    AssetsTestUtil.assertGetAssets(client, course, null, 5, 15, 12, function(pagedAssets) {
                      assert.strictEqual(pagedAssets.results.length, 0);

                      return callback();
                    });
                  });
                });
              });
            });
          });
        });
      });
    });

    /**
     * Test that verifies validation when getting the assets
     */
    it('is validated', function(callback) {
      TestsUtil.getAssetLibraryClient(null, null, null, function(client, course, user) {

        // Invalid asset type
        AssetsTestUtil.assertGetAssetsFails(client, course, {'types': 'invalid'}, null, null, 400, function() {
          AssetsTestUtil.assertGetAssetsFails(client, course, {'types': 42}, null, null, 400, function() {
            AssetsTestUtil.assertGetAssetsFails(client, course, {'types': ['invalid']}, null, null, 400, function() {
              AssetsTestUtil.assertGetAssetsFails(client, course, {'types': [42]}, null, null, 400, function() {
                return callback();
              });
            });
          });
        });
      });
    });

    /**
     * Set up a few categories in a course
     *
     * @param  {CanvasCourse}   course                  The course in which the categories should be created
     * @param  {Function}       callback                Standard callback function
     * @param  {Category}       callback.category1      The first category
     * @param  {Category}       callback.category2      The second category
     * @throws {AssertionError}                         Error thrown when an assertion failed
     * @api private
     */
    var setupCategories = function(course, callback) {
      var instructor = TestsUtil.generateInstructor();
      TestsUtil.getAssetLibraryClient(null, course, instructor, function(client, course, instructor) {
        CategoriesTestUtil.assertCreateCategory(client, course, 'Category 1', function(category1) {
          CategoriesTestUtil.assertCreateCategory(client, course, 'Category 2', function(category2) {
            return callback(category1, category2);
          });
        });
      });
    };

    /**
     * Create a few assets in a course
     *
     * @param  {CanvasCourse}   course                      The course in which the categories should be created
     * @param  {Category}       category1                   The first category
     * @param  {Category}       category2                   The second category
     * @param  {Function}       callback                    Standard callback function
     * @param  {Asset}          callback.berkeleyAsset      A link asset in the first category
     * @param  {Asset}          callback.davisAsset         A link asset in the second category
     * @param  {Asset}          callback.laAsset            A link asset in the first and second category
     * @param  {Asset}          callback.logoAsset          A file asset
     * @throws {AssertionError}                             Error thrown when an assertion failed
     * @api private
     */
    var setupAssets = function(course, category1, category2, callback) {
      TestsUtil.getAssetLibraryClient(null, course, null, function(client, course, user) {
        UsersTestUtil.assertGetMe(client, course, null, function(me) {
          // Create a few assets with lots of metadata
          var opts = {
            'categories': [category1.id],
            'description': 'University of California, Berkeley homepage, #ucberk',
            'source': 'http://www.universityofcalifornia.edu/uc-system'
          };
          AssetsTestUtil.assertCreateLink(client, course, 'UC Berkeley', 'http://www.berkeley.edu/', opts, function(berkeleyAsset) {
            CategoriesTestUtil.assertCategory(berkeleyAsset.categories[0], {'expectedCategory': category1});

            opts = {
              'categories': [category2.id],
              'description': 'University of California, Davis homepage, #ucdav',
              'source': 'http://www.universityofcalifornia.edu/uc-system'
            };
            AssetsTestUtil.assertCreateLink(client, course, 'UC Davis', 'http://www.ucdavis.edu/', opts, function(davisAsset) {
              CategoriesTestUtil.assertCategory(davisAsset.categories[0], {'expectedCategory': category2});

              opts = {
                'categories': [category1.id, category2.id],
                'description': 'University of California, Los Angeles homepage, #ucla',
                'source': 'http://www.universityofcalifornia.edu/uc-system'
              };
              AssetsTestUtil.assertCreateLink(client, course, 'UC Los Angeles', 'http://www.ucla.edu/', opts, function(laAsset) {
                CategoriesTestUtil.assertCategory(laAsset.categories[0], {'expectedCategory': category1});
                CategoriesTestUtil.assertCategory(laAsset.categories[1], {'expectedCategory': category2});

                var opts = {
                  'description': 'University of California, Berkeley logo, #ucberk',
                  'source': 'http://www.universityofcalifornia.edu/uc-system'
                };
                AssetsTestUtil.assertCreateFile(client, course, 'UC Berkeley', getFileStream('logo-ucberkeley.png'), opts, function(logoAsset) {

                  return callback(client, me, berkeleyAsset, davisAsset, laAsset, logoAsset);
                });
              });
            });
          });
        });
      });
    };

    /**
     * Verify that searching through the assets returns the expected assets
     *
     * @param  {RestClient}         client                    The REST client to make the request with
     * @param  {Course}             course                    The Canvas course in which the user is interacting with the API
     * @param  {Object}             [filters]                 A set of options to filter the results by
     * @param  {String}             [filters.keywords]        A string to filter the assets by
     * @param  {Number}             [filters.category]        The id of the category to filter the assets by
     * @param  {Number}             [filters.user]            The id of the user who created the assets
     * @param  {Number}             [filters.type]            The type of assets. One of `CollabosphereConstants.ASSET.ASSET_TYPES`
     * @param  {Asset[]}            expectedAssets            The expected assets
     * @param  {Function}           callback                  Standard callback function
     * @throws {AssertionError}                               Error thrown when an assertion failed
     * @api private
     */
    var verifySearch = function(client, course, filters, expectedAssets, callback) {
      AssetsTestUtil.assertGetAssets(client, course, filters, null, null, expectedAssets.length, function(assets) {
        expectedAssets = _.sortBy(expectedAssets, 'id').reverse();

        // The 'total' value should always equal the total count of expected assets
        assert.strictEqual(assets.total, expectedAssets.length);

        // If there are more than 10 expected assets, only the first 10 should be included in
        // paged results
        if (expectedAssets.length < 10) {
          assert.strictEqual(assets.results.length, expectedAssets.length);
        } else {
          assert.strictEqual(assets.results.length, 10);
        }

        _.each(assets.results, function(asset, i) {
          AssetsTestUtil.assertAsset(asset, {'expectedAsset': expectedAssets[i]});
        });
        return callback();
      });
    };

    /**
     * Test that verifies that assets can be searched through
     */
    it('can be searched through', function(callback) {
      var course = TestsUtil.generateCourse(global.tests.canvas.ucberkeley);
      setupCategories(course, function(category1, category2) {
        setupAssets(course, category1, category2, function(client, user1, berkeleyAsset1, davisAsset1, laAsset1, logoAsset1) {
          setupAssets(course, category1, category2, function(client, user2, berkeleyAsset2, davisAsset2, laAsset2, logoAsset2) {

            // All assets should be returned when no filters are specified
            var allAssets = [berkeleyAsset1, davisAsset1, laAsset1, logoAsset1, berkeleyAsset2, davisAsset2, laAsset2, logoAsset2];
            verifySearch(client, course, null, allAssets, function() {

              // Simple searches
              verifySearch(client, course, {'keywords': 'Los'}, [laAsset1, laAsset2], function() {
                verifySearch(client, course, {'keywords': 'Los Angeles'}, [laAsset1, laAsset2], function() {
                  verifySearch(client, course, {'keywords': 'This totally does not match anything'}, [], function() {
                    verifySearch(client, course, {'keywords': 'university Angeles'}, [laAsset1, laAsset2], function() {
                      verifySearch(client, course, {'keywords': 'Uni ang'}, [laAsset1, laAsset2], function() {
                        verifySearch(client, course, {'keywords': 'erkel'}, [berkeleyAsset1, berkeleyAsset2, logoAsset1, logoAsset2], function() {
                          verifySearch(client, course, {'category': category1.id}, [berkeleyAsset1, berkeleyAsset2, laAsset1, laAsset2], function() {
                            verifySearch(client, course, {'types': ['file']}, [logoAsset1, logoAsset2], function() {
                              verifySearch(client, course, {'types': ['file', 'link']}, [logoAsset1, logoAsset2, berkeleyAsset1, berkeleyAsset2, davisAsset1, davisAsset2, laAsset1, laAsset2], function() {
                                verifySearch(client, course, {'user': user1.id}, [berkeleyAsset1, davisAsset1, laAsset1, logoAsset1], function() {

                                  // Permutations of 2 options
                                  verifySearch(client, course, {'keywords': 'Los Angeles', 'category': category1.id}, [laAsset1, laAsset2], function() {
                                    verifySearch(client, course, {'keywords': 'Los Angeles', 'types': ['file']}, [], function() {
                                      verifySearch(client, course, {'keywords': 'Los Angeles', 'user': user2.id}, [laAsset2], function() {
                                        verifySearch(client, course, {'category': category1.id, 'types': ['file']}, [], function() {
                                          verifySearch(client, course, {'category': category1.id, 'user': user1.id}, [berkeleyAsset1, laAsset1], function() {
                                            verifySearch(client, course, {'types': ['file'], 'user': user1.id}, [logoAsset1], function() {
                                              verifySearch(client, course, {'types': ['file', 'link'], 'user': user1.id}, [logoAsset1, berkeleyAsset1, davisAsset1, laAsset1], function() {

                                                // Permutations of 3 options
                                                verifySearch(client, course, {'keywords': 'Los Angeles', 'category': category1.id, 'types': ['file']}, [], function() {
                                                  verifySearch(client, course, {'keywords': 'Los Angeles', 'category': category1.id, 'user': user1.id}, [laAsset1], function() {
                                                    verifySearch(client, course, {'keywords': 'Los Angeles', 'types': ['file'], 'user': user2.id}, [], function() {
                                                      verifySearch(client, course, {'category': category1.id, 'types': ['link'], 'user': user2.id}, [berkeleyAsset2, laAsset2], function() {
                                                        verifySearch(client, course, {'category': category1.id, 'types': ['link', 'file'], 'user': user2.id}, [berkeleyAsset2, laAsset2], function() {

                                                          return callback();
                                                        });
                                                      });
                                                    });
                                                  });
                                                });
                                              });
                                            });
                                          });
                                        });
                                      });
                                    });
                                  });
                                });
                              });
                            });
                          });
                        });
                      });
                    });
                  });
                });
              });
            });
          });
        });
      });
    });

    /**
     * Test that verifies that the search query searches through ALL assets and not the first ten
     * as this is a common Sequelize mistake
     */
    it('can search through many assets', function(callback) {
      // Create a couple of assets that we will eventually search for
      var course = TestsUtil.generateCourse(global.tests.canvas.ucberkeley);
      setupCategories(course, function(category1, category2) {
        setupAssets(course, category1, category2, function(client, user1, berkeleyAsset1, davisAsset1, laAsset1, logoAsset1) {

          // Now create a bunch of irrelevant assets
          setupCategories(course, function(category3, category4) {
            setupAssets(course, category3, category4, function(client, user3, berkeleyAsset3, davisAsset3, laAsset3, logoAsset3) {
              setupAssets(course, category3, category4, function(client, user4, berkeleyAsset4, davisAsset4, laAsset4, logoAsset4) {
                setupAssets(course, category3, category4, function(client, user5, berkeleyAsset5, davisAsset5, laAsset5, logoAsset5) {

                  // Search for the first assets
                  verifySearch(client, course, {'keywords': 'Los Angeles', 'category': category1.id}, [laAsset1], function() {
                    verifySearch(client, course, {'user': user1.id}, [berkeleyAsset1, davisAsset1, laAsset1, logoAsset1], function() {
                      verifySearch(client, course, {'user': user1.id, 'types': 'link'}, [berkeleyAsset1, davisAsset1, laAsset1], function() {
                        return callback();
                      });
                    });
                  });
                });
              });
            });
          });
        });
      });
    });

    /**
     * Test that verifies that hashtags can be searched for
     */
    it('can search for hashtags', function(callback) {
      // Create a couple of assets that we will search for
      var course = TestsUtil.generateCourse(global.tests.canvas.ucberkeley);
      setupCategories(course, function(category1, category2) {
        setupAssets(course, category1, category2, function(client, user, berkeleyAsset, davisAsset, laAsset, logoAsset) {

          // Verify that including the pound sign doesn't influence the hashtag search results
          verifySearch(client, course, {'keywords': 'ucla'}, [laAsset], function() {
            verifySearch(client, course, {'keywords': '#ucla'}, [laAsset], function() {
              return callback();
            });
          });
        });
      });
    });
  });

  describe('Edit asset', function() {

    /**
     * Test that verifies that an asset can be edited
     */
    it('can be edited', function(callback) {
      TestsUtil.getAssetLibraryClient(null, null, null, function(client, course, user) {
        AssetsTestUtil.assertCreateLink(client, course, 'UC Davis', 'http://www.ucdavis.edu/', null, function(asset) {

          // Verify that the title and the description can be updated
          AssetsTestUtil.assertEditAsset(client, course, asset.id, 'UC Berkeley', {'description': 'University of California, Berkeley'}, function(asset) {

            // Verify that the title can be updated and the description can be cleared
            AssetsTestUtil.assertEditAsset(client, course, asset.id, 'UC Berkeley', null, function(asset) {

              return callback();
            });
          });
        });
      });
    });

    /**
     * Test that verifies validation when editing an asset
     */
    it('is validated', function(callback) {
      TestsUtil.getAssetLibraryClient(null, null, null, function(client, course, user) {
        AssetsTestUtil.assertCreateLink(client, course, 'UC Davis', 'http://www.ucdavis.edu/', null, function(asset) {

          // Invalid asset id
          AssetsTestUtil.assertEditAssetFails(client, course, 'Not a number', 'UC Irvine', null, 400, function() {
            AssetsTestUtil.assertEditAssetFails(client, course, -1, 'UC Irvine', null, 404, function() {
              AssetsTestUtil.assertEditAssetFails(client, course, 234234233, 'UC Irvine', null, 404, function() {

                // Missing title
                AssetsTestUtil.assertEditAssetFails(client, course, asset.id, null, null, 400, function() {
                  AssetsTestUtil.assertEditAssetFails(client, course, asset.id, '', null, 400, function() {
                    // Too long title
                    AssetsTestUtil.assertEditAssetFails(client, course, asset.id, randomstring.generate(256), null, 400, function() {

                      return callback();
                    });
                  });
                });
              });
            });
          });
        });
      });
    });

    /**
     * Test that verifies authorization when editing an asset
     */
    it('verifies authorization', function(callback) {
      TestsUtil.getAssetLibraryClient(null, null, null, function(client1, course1, user1) {
        AssetsTestUtil.assertCreateLink(client1, course1, 'UC Davis', 'http://www.ucdavis.edu/', null, function(asset) {

          // Verify that the asset can be edited by the user that added the asset
          AssetsTestUtil.assertEditAsset(client1, course1, asset.id, 'UC Berkeley', null, function(asset) {

            // Verify that the asset can be edited by an instructor of the course
            var instructor1 = TestsUtil.generateInstructor();
            TestsUtil.getAssetLibraryClient(null, course1, instructor1, function(client2, course1, instructor1) {
              AssetsTestUtil.assertEditAsset(client1, course1, asset.id, 'UCLA', null, function(asset) {

                // Verify that an asset can not be edited by a regular student
                TestsUtil.getAssetLibraryClient(null, course1, null, function(client3, course1, user2) {
                  AssetsTestUtil.assertEditAssetFails(client3, course1, asset.id, 'UC Irvine', null, 401, function() {

                    // Verify that an instructor in a different course can not edit the asset
                    var instructor2 = TestsUtil.generateInstructor();
                    TestsUtil.getAssetLibraryClient(null, null, instructor2, function(client4, course2, instructor2) {
                      AssetsTestUtil.assertEditAssetFails(client4, course2, asset.id, 'UC Irvine', null, 404, function() {

                        // Verify that the asset has not been updated
                        AssetsTestUtil.assertGetAsset(client1, course1, asset.id, asset, 0, function(asset) {

                          return callback();
                        });
                      });
                    });
                  });
                });
              });
            });
          });
        });
      });
    });
  });

  describe('Delete asset', function() {

    /**
     * Test that verifies that an asset can be deleted by an administrator
     */
    it('can be deleted by instructor', function(callback) {
      var instructor = TestsUtil.generateInstructor();
      TestsUtil.getAssetLibraryClient(null, null, instructor, function(client1, course, instructor) {
        AssetsTestUtil.assertCreateLink(client1, course, 'UC Berkeley', 'http://www.ucberkeley.edu/', null, function(asset1) {

          // Verify that the asset can be deleted
          AssetsTestUtil.assertDeleteAsset(client1, course, asset1.id, function() {

            // Verify that an asset with likes and comments can be deleted
            AssetsTestUtil.assertCreateLink(client1, course, 'UC Davis', 'http://www.ucdavis.edu/', null, function(asset2) {
              // Like the asset
              TestsUtil.getAssetLibraryClient(null, course, null, function(client2, course, user2) {
                AssetsTestUtil.assertLike(client2, course, asset2.id, true, function() {
                  // Add a comment to the asset
                  TestsUtil.getAssetLibraryClient(null, course, null, function(client3, course, user3) {
                    AssetsTestUtil.assertCreateComment(client3, course, asset2.id, 'Comment 1', null, function(comment) {
                      // Verify that the asset can be deleted
                      AssetsTestUtil.assertDeleteAsset(client1, course, asset2.id, function() {

                        // Sanity check there are no assets in the asset library
                        AssetsTestUtil.assertGetAssets(client1, course, null, null, null, 0, function(assets) {
                          assert.strictEqual(assets.total, 0);
                          assert.strictEqual(assets.results.length, 0);
                          return callback();
                        });
                      });
                    });
                  });
                });
              });
            });
          });
        });
      });
    });

    /**
     * Test that verifies that an asset with no interactions can be deleted by an associated user
     */
    it('can be deleted by user', function(callback) {
      TestsUtil.getAssetLibraryClient(null, null, null, function(client1, course, user1) {
        AssetsTestUtil.assertCreateLink(client1, course, 'UC Berkeley', 'http://www.ucberkeley.edu/', null, function(asset1) {

          // Verify that a different user cannot delete the asset
          TestsUtil.getAssetLibraryClient(null, course, null, function(client2, course, user2) {
            AssetsTestUtil.assertDeleteAssetFails(client2, course, asset1.id, 401, function() {
              //Verify that the creator can delete the asset
              AssetsTestUtil.assertDeleteAsset(client1, course, asset1.id, function() {

                // Create an asset with comments
                AssetsTestUtil.assertCreateLink(client1, course, 'UC Davis', 'http://www.ucdavis.edu/', null, function(asset2) {
                  AssetsTestUtil.assertCreateComment(client2, course, asset2.id, 'Comment 1', null, function(comment) {
                    // Verify that the creator cannot delete the commented asset
                    AssetsTestUtil.assertDeleteAssetFails(client1, course, asset2.id, 401, function() {

                      // Create an asset with likes
                      AssetsTestUtil.assertCreateLink(client1, course, 'UC Riverside', 'http://www.ucr.edu/', null, function(asset3) {
                        AssetsTestUtil.assertLike(client2, course, asset3.id, true, function() {
                          // Verify that the creator cannot delete the liked asset
                          AssetsTestUtil.assertDeleteAssetFails(client1, course, asset3.id, 401, function() {

                            // Create an asset for use in a whiteboard
                            AssetsTestUtil.assertCreateLink(client1, course, 'UC Riverside', 'http://www.ucr.edu/', null, function(asset4) {
                              UsersTestUtil.assertGetMe(client1, course, null, function(user1Me) {
                                WhiteboardsTestUtil.assertCreateWhiteboard(client1, course, 'UC Riverside Whiteboard', [user1Me.id], function(whiteboard) {
                                  WhiteboardsTestUtil.addAssetToWhiteboard(client1, course, asset4, whiteboard, function() {
                                    // Verify that the creator cannot delete the used asset
                                    AssetsTestUtil.assertDeleteAssetFails(client1, course, asset4.id, 401, function() {

                                      // Export the whiteboard and remove asset from active whiteboard
                                      WhiteboardsTestUtil.assertExportWhiteboardToAsset(client1, course, whiteboard.id, null, null, function(exportedAsset) {
                                        WhiteboardsTestUtil.removeAssetFromWhiteboard(client1, course, asset4, whiteboard, function() {
                                          // Verify that the creator cannot delete the asset
                                          AssetsTestUtil.assertDeleteAssetFails(client1, course, asset4.id, 401, function() {

                                            // Delete the exported whiteboard
                                            AssetsTestUtil.assertDeleteAsset(client1, course, exportedAsset.id, function() {
                                              // Verify that the creator can delete the asset
                                              AssetsTestUtil.assertDeleteAsset(client1, course, asset4.id, function() {

                                                return callback();
                                              });
                                            });
                                          });
                                        });
                                      });
                                    });
                                  });
                                });
                              });
                            });
                          });
                        });
                      });
                    });
                  });
                });
              });
            });
          });
        });
      });
    });

    /**
     * Test that verifies validation when deleting a category
     */
    it('is validated', function(callback) {
      var instructor = TestsUtil.generateInstructor();
      TestsUtil.getAssetLibraryClient(null, null, instructor, function(client, course, instructor) {
        AssetsTestUtil.assertCreateLink(client, course, 'UC Berkeley', 'http://www.ucberkeley.edu/', null, function(asset) {

          // Invalid asset id
          AssetsTestUtil.assertDeleteAssetFails(client, course, 'Not a number', 400, function() {
            AssetsTestUtil.assertDeleteAssetFails(client, course, -1, 404, function() {
              AssetsTestUtil.assertDeleteAssetFails(client, course, 234234233, 404, function() {

                return callback();
              });
            });
          });
        });
      });
    });

    /**
     * Test that verifies authorization when deleting a category
     */
    it('verifies authorization', function(callback) {
      var instructor1 = TestsUtil.generateInstructor();
      TestsUtil.getAssetLibraryClient(null, null, instructor1, function(client1, course1, instructor1) {
        AssetsTestUtil.assertCreateLink(client1, course1, 'UC Berkeley', 'http://www.ucberkeley.edu/', null, function(asset1) {

          // Verify that an asset can not be deleted by a non-administrator
          TestsUtil.getAssetLibraryClient(null, course1, null, function(client2, course, user2) {
            AssetsTestUtil.assertDeleteAssetFails(client2, course1, asset1.id, 401, function() {

              // Verify that the asset has not been deleted
              AssetsTestUtil.assertGetAsset(client2, course1, asset1.id, asset1, 0, function() {

                // Verify that an asset in a different course can not be deleted
                var instructor2 = TestsUtil.generateInstructor();
                TestsUtil.getAssetLibraryClient(null, null, instructor2, function(client3, course2, instructor2) {
                  AssetsTestUtil.assertCreateLink(client3, course2, 'UC Davis', 'http://www.ucdavis.edu/', null, function(asset2) {
                    AssetsTestUtil.assertDeleteAssetFails(client1, course2, asset2.id, 401, function() {

                      // Verify that the asset has not been deleted
                      AssetsTestUtil.assertGetAsset(client3, course2, asset2.id, asset2, 0, function() {

                        return callback();
                      });
                    });
                  });
                });
              });
            });
          });
        });
      });
    });
  });
});
