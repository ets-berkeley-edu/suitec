/**
 * Copyright 2015 UC Berkeley (UCB) Licensed under the
 * Educational Community License, Version 2.0 (the "License"); you may
 * not use this file except in compliance with the License. You may
 * obtain a copy of the License at
 *
 *     http://opensource.org/licenses/ECL-2.0
 *
 * Unless required by applicable law or agreed to in writing,
 * software distributed under the License is distributed on an "AS IS"
 * BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express
 * or implied. See the License for the specific language governing
 * permissions and limitations under the License.
 */

var _ = require('lodash');
var assert = require('assert');

var CategoriesTestUtil = require('col-categories/tests/util');
var TestsUtil = require('col-tests');

var AssetsTestUtil = require('./util');

describe('Assets', function() {

  describe('Categories', function() {

    describe('Create new assets', function() {

      /**
       * Test that verifies that a new asset can be created with associated categories
       */
      it('can be created', function(callback) {
        var adminUser = TestsUtil.generateAdminUser();
        TestsUtil.getAssetLibraryClient(null, null, adminUser, function(client, course, adminUser) {
          CategoriesTestUtil.assertCreateCategory(client, course, 'Category 1', function(category1) {
            CategoriesTestUtil.assertCreateCategory(client, course, 'Category 2', function(category2) {

              // Verify that a new asset can be created with a single associated category
              var opts = {'categories': category1.id};
              AssetsTestUtil.assertCreateLink(client, course, 'UC Davis', 'http://www.ucdavis.edu/', opts, function(asset) {
                CategoriesTestUtil.assertCategory(asset.categories[0], category1);

                // Verify that a new asset can be created with multiple associated categories
                opts = {'categories': [category1.id, category2.id]};
                AssetsTestUtil.assertCreateLink(client, course, 'UC Berkeley', 'http://www.berkeley.edu/', opts, function(asset) {
                  CategoriesTestUtil.assertCategory(asset.categories[0], category1);
                  CategoriesTestUtil.assertCategory(asset.categories[1], category2);

                  return callback();
                });
              });
            });
          });
        });
      });

      /**
       * Test that verifies validation when creating a new asset with associated categories
       */
      it('is validated', function(callback) {
        var adminUser = TestsUtil.generateAdminUser();
        TestsUtil.getAssetLibraryClient(null, null, adminUser, function(client, course, adminUser) {
          CategoriesTestUtil.assertCreateCategory(client, course, 'Category 1', function(category) {

            // Invalid category id
            var opts = {'categories': 'Not a number'};
            AssetsTestUtil.assertCreateLinkFails(client, course, 'UC Davis', 'http://www.ucdavis.edu/', opts, 400, function() {
              opts = {'categories': -1};
              AssetsTestUtil.assertCreateLinkFails(client, course, 'UC Davis', 'http://www.ucdavis.edu/', opts, 404, function() {
                opts = {'categories': 234234233};
                AssetsTestUtil.assertCreateLinkFails(client, course, 'UC Davis', 'http://www.ucdavis.edu/', opts, 404, function() {

                  // Invalid category id mixed in with valid category id
                  opts = {'categories': [category.id, 'Not a number']};
                  AssetsTestUtil.assertCreateLinkFails(client, course, 'UC Davis', 'http://www.ucdavis.edu/', opts, 400, function() {
                    opts = {'categories': [category.id, -1]};
                    AssetsTestUtil.assertCreateLinkFails(client, course, 'UC Davis', 'http://www.ucdavis.edu/', opts, 404, function() {
                      opts = {'categories': [category.id, 234234233]};
                      AssetsTestUtil.assertCreateLinkFails(client, course, 'UC Davis', 'http://www.ucdavis.edu/', opts, 404, function() {

                        // Duplicate category id
                        opts = {'categories': [category.id, category.id]};
                        AssetsTestUtil.assertCreateLinkFails(client, course, 'UC Davis', 'http://www.ucdavis.edu/', opts, 400, function() {

                          return callback();
                        });
                      });
                    });
                  });
                });
              });
            });
          });
        });
      });

      /**
       * Test that verifies authorization when create a new asset with associated categories
       */
      it('verifies authorization', function(callback) {
        var adminUser1 = TestsUtil.generateAdminUser();
        TestsUtil.getAssetLibraryClient(null, null, adminUser1, function(client1, course1, adminUser1) {
          CategoriesTestUtil.assertCreateCategory(client1, course1, 'Category 1', function(category) {

            // Verify that a category in a different course can not be used
            TestsUtil.getAssetLibraryClient(null, null, null, function(client2, course2, user2) {
              var opts = {'categories': category.id};
              AssetsTestUtil.assertCreateLinkFails(client2, course2, 'UC Davis', 'http://www.ucdavis.edu/', opts, 404, function() {

                return callback();
              });
            });
          });
        });
      });
    });
  });
});
