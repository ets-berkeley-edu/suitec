/**
 * Copyright 2015 UC Berkeley (UCB) Licensed under the
 * Educational Community License, Version 2.0 (the "License"); you may
 * not use this file except in compliance with the License. You may
 * obtain a copy of the License at
 *
 *     http://opensource.org/licenses/ECL-2.0
 *
 * Unless required by applicable law or agreed to in writing,
 * software distributed under the License is distributed on an "AS IS"
 * BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express
 * or implied. See the License for the specific language governing
 * permissions and limitations under the License.
 */

var Collabosphere = require('col-core');

var AssetsAPI = require('./api');

/*!
 * Get an asset
 */
Collabosphere.apiRouter.get('/assets/:assetId', function(req, res) {
  AssetsAPI.getAsset(req.ctx, req.params.assetId, true, function(err, asset) {
    if (err) {
      return res.status(err.code).send(err.msg);
    }

    return res.status(200).send(asset);
  });
});

/*!
 * Get the assets in the current course
 */
Collabosphere.apiRouter.get('/assets', function(req, res) {
  AssetsAPI.getAssets(req.ctx, req.query.limit, req.query.offset, function(err, assets) {
    if (err) {
      return res.status(err.code).send(err.msg);
    }

    return res.status(200).send(assets);
  });
});

/*!
 * Create a new asset
 */
Collabosphere.apiRouter.post('/assets', function(req, res) {
  // Create a new link asset
  if (req.body.type === 'link') {
    var opts = {
      'description': req.body.description,
      'source': req.body.source
    };
    AssetsAPI.createLink(req.ctx, req.body.title, req.body.url, opts, function(err, createdLink) {
      if (err) {
        console.log(err);
        return res.status(err.code).send(err.msg);
      }

      return res.status(201).send(createdLink);
    });

  // Create a new file asset
  } else if (req.body.type === 'file') {
    return res.send(501);

  // Unrecognized asset type
  } else {
    return res.status(400).send('Unrecognized asset type');
  }
});

/*!
 * Create a new comment on an asset
 */
Collabosphere.apiRouter.post('/assets/:assetId/comments', function(req, res) {
  AssetsAPI.createComment(req.ctx, req.params.assetId, req.body.body, req.body.parent, function(err, comment) {
    if (err) {
      return res.status(err.code).send(err.msg);
    }

    return res.status(201).send(comment);
  });
});

/*!
 * Edit a comment on an asset
 */
Collabosphere.apiRouter.post('/assets/:assetId/comments/:commentId', function(req, res) {
  AssetsAPI.editComment(req.ctx, req.params.assetId, req.params.commentId, req.body.body, function(err, comment) {
    if (err) {
      return res.status(err.code).send(err.msg);
    }

    return res.status(200).send(comment);
  });
});
