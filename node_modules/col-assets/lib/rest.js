/**
 * Copyright 2015 UC Berkeley (UCB) Licensed under the
 * Educational Community License, Version 2.0 (the "License"); you may
 * not use this file except in compliance with the License. You may
 * obtain a copy of the License at
 *
 *     http://opensource.org/licenses/ECL-2.0
 *
 * Unless required by applicable law or agreed to in writing,
 * software distributed under the License is distributed on an "AS IS"
 * BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express
 * or implied. See the License for the specific language governing
 * permissions and limitations under the License.
 */

var Collabosphere = require('col-core');
var CollabosphereUtil = require('col-core/lib/util');

var AssetsAPI = require('./api');

/*!
 * Get an asset
 */
Collabosphere.apiRouter.get('/assets/:assetId', function(req, res) {
  // Always increment the views when getting an asset, unless this is
  // explicitly disabled
  var incrementViews = true;
  if (CollabosphereUtil.getBooleanParam(req.query.incrementViews) === false) {
    incrementViews = false;
  }

  AssetsAPI.getAssetProfile(req.ctx, req.params.assetId, incrementViews, function(err, asset) {
    if (err) {
      return res.status(err.code).send(err.msg);
    }

    return res.status(200).send(asset);
  });
});

/*!
 * Get the assets in the current course
 */
Collabosphere.apiRouter.get('/assets', function(req, res) {
  var filters = {
    'keywords': req.query.keywords,
    'user': req.query.user,
    'category': req.query.category,
    'types': CollabosphereUtil.toArray(req.query.type)
  };
  AssetsAPI.getAssets(req.ctx, filters, req.query.limit, req.query.offset, function(err, assets) {
    if (err) {
      return res.status(err.code).send(err.msg);
    }

    return res.status(200).send(assets);
  });
});

/*!
 * Create a new asset
 */
Collabosphere.apiRouter.post('/assets', function(req, res) {
  var categories = CollabosphereUtil.toArray(req.body.categories);
  var opts = {
    'categories': categories,
    'description': req.body.description,
    'source': req.body.source
  };

  // Create a new link asset
  if (req.body.type === 'link') {
    AssetsAPI.createLink(req.ctx, req.body.title, req.body.url, opts, function(err, createdLink) {
      if (err) {
        return res.status(err.code).send(err.msg);
      }

      return res.status(201).send(createdLink);
    });

  // Create a new file asset
  } else if (req.body.type === 'file') {
    AssetsAPI.createFile(req.ctx, req.body.title, req.files.file, opts, function(err, createdFile) {
      if (err) {
        return res.status(err.code).send(err.msg);
      }

      return res.status(201).send(createdFile);
    });

  // Unrecognized asset type
  } else {
    return res.status(400).send('Unrecognized asset type');
  }
});

/*!
 * Edit an asset
 */
Collabosphere.apiRouter.post('/assets/:id', function(req, res) {
  var categories = CollabosphereUtil.toArray(req.body.categories);
  var opts = {
    'categories': categories,
    'description': req.body.description
  };

  AssetsAPI.editAsset(req.ctx, req.params.id, req.body.title, opts, function(err, asset) {
    if (err) {
      return res.status(err.code).send(err.msg);
    }

    return res.status(200).send(asset);
  });
});

/*!
 * Create a new comment on an asset
 */
Collabosphere.apiRouter.post('/assets/:assetId/comments', function(req, res) {
  AssetsAPI.createComment(req.ctx, req.params.assetId, req.body.body, req.body.parent, function(err, comment) {
    if (err) {
      return res.status(err.code).send(err.msg);
    }

    return res.status(201).send(comment);
  });
});

/*!
 * Edit a comment on an asset
 */
Collabosphere.apiRouter.post('/assets/:assetId/comments/:commentId', function(req, res) {
  AssetsAPI.editComment(req.ctx, req.params.assetId, req.params.commentId, req.body.body, function(err, comment) {
    if (err) {
      return res.status(err.code).send(err.msg);
    }

    return res.status(200).send(comment);
  });
});

/*!
 * Delete a comment on an asset
 */
Collabosphere.apiRouter.delete('/assets/:assetId/comments/:commentId', function(req, res) {
  AssetsAPI.deleteComment(req.ctx, req.params.assetId, req.params.commentId, function(err) {
    if (err) {
      return res.status(err.code).send(err.msg);
    }

    return res.status(200).send();
  });
});

/*!
 * Like or dislike an asset
 */
Collabosphere.apiRouter.post('/assets/:assetId/like', function(req, res) {
  var like = CollabosphereUtil.getBooleanParam(req.body.like);
  AssetsAPI.like(req.ctx, req.params.assetId, like, function(err) {
    if (err) {
      return res.status(err.code).send(err.msg);
    }

    return res.sendStatus(200);
  });
});
